<html>
<header>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <title>AIO-IR system</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</header>
<body onload="on_load();">
    <style>
        *{
            margin: 0;
        }
        body{
          margin: 0;
        }
        
        .custom-btn {
          color: #fff;
          border-radius: 5px;
          /* padding: 10px 25px; */
          font-family: 'Lato', sans-serif;
          background: transparent;
          cursor: pointer;
          transition: all 0.3s ease;
          position: relative;
          display: inline-block;
          box-shadow:inset 2px 2px 2px 0px rgba(255,255,255,.5),
          7px 7px 20px 0px rgba(0,0,0,.1),
          4px 4px 5px 0px rgba(0,0,0,.1);
          outline: none;
        }

        .btn-13 {
          background-color: #89d8d3;
          background-image: linear-gradient(315deg, #89d8d3 0%, #03c8a8 74%);
          border: none;
          z-index: 1;
        }
        .btn-13:after {
          position: absolute;
          content: "";
          width: 100%;
          height: 0;
          bottom: 0;
          left: 0;
          z-index: -1;
          border-radius: 5px;
          background-color: #4dccc6;
        background-image: linear-gradient(315deg, #4dccc6 0%, #96e4df 74%);
          box-shadow:
          -7px -7px 20px 0px #fff9,
          -4px -4px 5px 0px #fff9,
          7px 7px 20px 0px #0002,
          4px 4px 5px 0px #0001;
          transition: all 0.3s ease;
        }
        .btn-13:hover {
          color: #fff;
        }
        .btn-13:hover:after {
          top: 0;
          height: 100%;
        }
        .btn-13:active {
          top: 2px;
        }

        .container{
          width: 100%;
          height: 100%;
          background-color: #e0e5ec;;
        }
        /* search */
        .search_container{
          width: 100%;
          height: 100px;
          display: grid;
          grid-template-columns: auto 439px;
          border-bottom: 5px solid #4dccc6;
        }
        .search{
          width: 100%;
          height: 100%;
          padding: 20px;
         
        }
        .search label{
          position: absolute;
          font-size: 30px;
          padding: 10px
        }
        .search input{
          width: 96%;
          height: 50px;
          border: none;
          border-radius: 10px;
          padding-left: 5%;
          font-size: 20px;
        }
        .group_btn{
          width: 100%;
          height: 100%;
          padding-top: 20px;
        }
        .group_btn button{
          width: 130px;
          height: 50px;
          border-radius: 10px;
          margin-right: 3%;
          color: white;
          font-size: 20px;
        }
        /* search */
    
        /* selection_1 */
        .selection_1{
          width: 100%;
          height: 55px;
          display: grid;
          grid-template-columns: auto 700px;
          padding-top: 2px;
        }

        .search_asr {
        height: 100%;
        background-color: bdc0c5;
        padding-left: 20px;
      }
      .search_asr label{
        font-size: 18px;
      }
      .search_asr input{
        height: 40px;
        width: 415px;
        border-radius: 10px;
        border: none;
        margin: 5px 10px 0 10px;
        padding-left: 3%;
        font-size: 13px;
      }
      .search_asr button{
        width: 80px;
        height: 40px;
        color: white;
        border-radius: 10px;
        font-size: 15px;
      }

      .search_ocr{
        height: 100%;
        background-color: bdc0c5;
        padding-left: 15px;
      }

      .search_ocr label{
        font-size: 18px;
      }
      .search_ocr input{
        height: 40px;
        width: 415px;
        border-radius: 10px;
        border: none;
        margin: 5px 10px 0 10px;
        padding-left: 3%;
        font-size: 13px;
      }
      .search_ocr button{
        width: 80px;
        height: 40px;
        color: white;
        border-radius: 10px;
        font-size: 15px;
      }

      /* selection_2*/
        .selection_2{
          width: 100%;
          height: 55px;
          display: grid;
          grid-template-columns: 670px auto 310px;
          padding-top: 2px;
        }

       .img_path{
        height: 100%;
        background-color: #bdc0c5;
        padding-left: 20px;
       }
       .img_path label{
        font-size: 18px;
      }
      .img_path input{
        height: 40px;
        width: 429px;
        border-radius: 10px;
        border: none;
        margin: 5px 10px 0 10px;
        padding-left: 2%;
        font-size: 13px;
      }
      .img_path button{
        width: 80px;
        height: 40px;
        color: white;
        border-radius: 10px;
        font-size: 15px;
      }

      .csv{
        width: 98%;
        height: 100%;
        padding-left: 69px;
        background-color: bdc0c5;
       }
       .csv label{
        font-size: 18px;
       }
       .csv select{
        width: 80px;
        height: 40px;
        border-radius: 10px;
        border: none;
        margin: 5px 3px 0 10px;
        padding-left: 5px;
        font-size: 13px;
       }

       .num_querry{
        background-color: bdc0c5;
        padding-left: 49px;
       }
       .num_querry label{
        font-size: 18px;
       }
       .num_querry input{
        width: 45px;
        height: 40px;
        border-radius: 10px;
        border: none;
        margin:5px 5px 0 5px;
        padding-left: 4%;
        font-size: 13px;
       }
       .num_querry button{
        width: 80px;
        height: 40px;
        color: white;
        border-radius: 10px;
        font-size: 15px;
       }
       
      
        /* selection */
    
        /* list img */
        .image{
          width: 100%;
          height: 100%;
        }
        /* list img */
    
        /* add image button */
        #div_img {
                display: flex;
                flex-direction: row;    
                flex-wrap: wrap;
                padding: 20px;
                background-color: #e0e5ec;
                /* height: 120px;
                width: 516px; */
            }
    
            .container_img_btn {
                position: relative;
                width: 100%;
                max-width: 318px;
                display: grid;
                grid-template-columns: auto auto auto auto;
                padding: 1%;
                cursor: pointer;
            }
            
            .container_img_btn img {
                width: 100%;
                height: 100%;
            }
    
            .container_img_btn .btn_knn {
                display: none;
                position: absolute;
                top: 50%;
                left: 10%;
                background-color: #4dccc6;
                color: white;
                font-size: 16px;
                padding: 5px 12px;
                cursor: pointer;
                border-radius: 5px;
                text-align: center;
            }
            .container_img_btn .btn_select {
                display: none;
                position: absolute;
                top: 50%;
                right: 10%;
                background-color: #4dccc6;
                color: white;
                font-size: 16px;
                padding: 5px 12px;
                cursor: pointer;
                border-radius: 5px;
                text-align: center;
            }
            
            .container_img_btn .btn_knn:hover{
              background-color: #145552;
            }

            .container_img_btn .btn_select:hover{
              background-color: #145552;
            }
    
            .container_img_btn img:hover{
                border: 4px solid #4dccc6;
            }
            /* .container_img_btn img:focus{hoverImg
                border: 1px solid blue;
            } */
            /* poup */
            #popup_canvas{
                width: 100%;
                height: 100%;
            }
    
            #popup_fname_div{
                position: fixed;
                margin-left: 25%;
                margin-top: 60%;
                color: rgb(0,255,0);
                font-size: 30;
            }

            @supports (display: flex) {
            @media screen and (min-width: 1024px) {
              article {
                display: flex;
              }
            }
          }

          @supports (display: grid) {
            @media screen and (min-width: 1024px) {
              article {
                display: grid;
              }
            }
          }
    
      </style>
    <div class="container">
        <div class="search_container">
          <div class="search">
           
            <label for="">
              <i class="fa fa-search" aria-hidden="true"></i>
            </label>
            <input id="text_query" type="text" placeholder="Text query">
          </div>
          <div class="group_btn">
            <button class="custom-btn btn-13" onclick="search();"><span>Search</span></button>
            <button class="custom-btn btn-13" onclick="reset()"><span>Clear</span></button>
            <button class="custom-btn btn-13" onclick="download_btn()"><span>Submit</span></button>
          </div>
  
        </div>
        <div class="selection_1">

          <div class="search_asr">
            <label for="">Bert search</label>
             <input id="text_asr" type="text" placeholder="ASR query"></input>
            <button class="custom-btn btn-13" onclick="search_asr();"><span>Search</span></button>
        </div>

        <div class="search_ocr">
          <label for="">OCR+ASR FILTER</label>
          <input placeholder="Input string" id="ocr_filter">
          <button class="custom-btn btn-13" onclick="ocr_filter();"><span>Search</span></button>
        </div>
      </div>
        

        <div class="selection_2">

          <div class="img_path">
            <label for="">IMAGE PATH</label>
            <input id="search_image_path" type="text" placeholder="C00_V0130/028539"></input>
            <button class="custom-btn btn-13" onclick="search_image_path();"><span>Search</span></button>
          </div>

        <div class="csv">
          <label for="mode_csv">CHOOSE WRITE MODE TO CSV</label>
          <select name="" id="mode_write_csv">
            <option value="single">Single</option>
            <option value="list_shot">List_shot</option>
          </select>
          
        </div>
  
          <div class="num_querry">
            <label for="">FILE QUERY</label>
            <input  type="number" placeholder="1" id="number_of_query">
            <button class="custom-btn btn-13" onclick="visualize();"><span>Visualize</span></button>
          </div>
        </div>

        <!-- <div style="height: 5px; width: 100%; background-color: black; margin-bottom: 5px; margin-top: 5px;"></div> -->
        <div id="div_img">
            
        </div>
  
        <div style="height: 5px; width: 100%; background-color: black;"></div>
        <div id="div_page">
            
        </div>
        <div id="div_total_page">Total: 1200 page</div>
        <div style="margin-bottom: 50px;"></div>
  
      </div>
    <script>
        var data = '{{ data|tojson }}';
        data = data.replace(/\s/g, '');
        data = data.replace(/\\/g, '/');
        data = JSON.parse(data);
        let btn_knn = document.getElementsByClassName("btn_knn");
        let btn_select = document.getElementsByClassName("btn_select");
        let hoverImg = document.getElementsByClassName("hoverImg");
        // console.log("data: " + JSON.stringify(data))
        function add_paging(){
            console.log(data['num_page']);
            var url = new URL(window.location.href);
            var cur_index = parseInt(url.searchParams.get("index"));
            var imgpath = url.searchParams.get("imgpath");
            // var labelpath = url.searchParams.get("labelpath");
            if (cur_index == 'undefined'){
                cur_index = 0;
            }
            var i = cur_index-4;
            if (i > 0){
                var iDiv = document.createElement('div');
                iDiv.className = 'page_num';
                iDiv.innerHTML = "...";
                document.getElementById("div_page").appendChild(iDiv);
            }
            for (i; ((i < data['num_page']) && (i < cur_index+4)); i++){
                if (i < 0){
                    i = 0;
                }
                var iDiv = document.createElement('div');
                iDiv.className = 'page_num';
                var iA = document.createElement('a');
                // iA.href = "?index="+i.toString()+"&imgpath="+imgpath+"&labelpath="+labelpath;
                iA.href = "?index="+i.toString()+"&imgpath="+imgpath;
                iA.innerHTML = i.toString();
                if (i == cur_index){
                    iA.style.color="green";
                }
                iDiv.appendChild(iA);
                document.getElementById("div_page").appendChild(iDiv);
            }
            if (i < data['num_page']){
                var iDiv = document.createElement('div');
                iDiv.className = 'page_num';
                iDiv.innerHTML = "...";
                document.getElementById("div_page").appendChild(iDiv);
            }
            document.getElementById("div_total_page").innerHTML = "Total: "+data['num_page'].toString()+" page";
        }
        
        function add_img(div_id_image){
            let div_img = document.getElementById("div_img");
            let pagefile_list = data['pagefile'];
            
            pagefile_list.forEach((item,index) => {
                // console.log('item: ' + JSON.stringify(item))
                $("#div_img").append(
                    `<div class= "container_img_btn"  onmouseover="mouseOver(${index})" onmouseout="mouseOut(${index})">
                        <button class="btn_knn" onClick="go_img_search(${item.id})">IR</button>
                        <button class="btn_select" onClick="writecsv(${index},'${item.id},${item.imgpath}')">SELECT</button>
                        <img class="hoverImg" onclick="show_list_segment(${item.id})" src="get_img?fpath=${item.imgpath}">
                        
                    </div>`
                )
            });
        
        }
        
        function mouseOver(id){
            // console.log('type: ' + typeof(btn_knn))
            btn_knn[id].style.display="block";
            btn_select[id].style.display="block";
        }
        function mouseOut(id){
            // console.log('type: ' + typeof(btn_knn))
            btn_knn[id].style.display="none";
            btn_select[id].style.display="none";
        }
        function go_img_search(id){
            window.open("/imgsearch?imgid="+id);
        }

        function on_load(){
            var url = new URL(window.location.href);
            var imgpath = url.searchParams.get("imgpath");
            // var labelpath = url.searchParams.get("labelpath");
            // document.getElementById('imgpath').value = imgpath;
            // document.getElementById('labelpath').value = labelpath;
            if("query" in data){
              document.getElementById("text_query").value = data["query"]
            }
            add_paging();
            add_img("div_img");
        }

        function show_list_segment(id){
            window.open("/showsegment?imgid="+id);
        }
        function writecsv(id,info_key){
            hoverImg[id].style.border="4px solid red";

            console.log("info_key: " + info_key);
            var mode_write_csv = document.getElementById("mode_write_csv").value;
            console.log("mode_write_csv: " + mode_write_csv);
            var info = {};
            $.ajax({
                url: "writecsv?info_key="+info_key+"&mode="+mode_write_csv,
                type: 'GET',
                async: false,
                dataType: 'json',
                success: function(res) {
                    console.log("res: ", res);
                    info = res;
                }
            });
            
            str_fname = info["str_fname"]
            console.log("str_fname: " + str_fname);
            number_line = info["number_line"]
            my_alert = str_fname + ' ### number csv line: ' + number_line

            // hoverImg[id].style.border="4px solid red";

            alert("write list shot: " + my_alert);
        }
        
        function visualize(){
            var number_of_query=document.getElementById('number_of_query').value;
            console.log("number_of_query: "+number_of_query);
            window.location.href = "visualize?number_of_query="+number_of_query;
        }

        function search_image_path(){
            frame_path = document.getElementById('search_image_path').value;

            window.open("/search_image_path?frame_path="+frame_path)
            
        }

        function search(){
            text_query = document.getElementById('text_query').value;

            window.location.href = "/textsearch?textquery="+text_query;
            
            document.getElementById('text_query').innerHTML = text_query;
        }
        
        function search_asr(){
            text_asr = document.getElementById('text_asr').value;

            window.open("/asrsearch?text_asr="+text_asr);
        }

        function ocr_filter() {
          ocr_query = document.getElementById('ocr_filter').value;
          console.log(ocr_query);
          window.open("/ocrfilter?text_ocr="+ocr_query);
        }

        function reset() {
            alert("Clean file submit.csv");
            window.location.href = "http://0.0.0.0:5001/thumbnailimg?index=0";
            // window.location.href = "http://127.0.0.1:5001/thumbnailimg?index=0"
        }

        function download_btn(){
            // window.location.href = "dowload_submit_file?filename=submit.csv"
            $.ajax({
                type: "GET",
                url: "get_first_row",
                dataType: "json",
                success: function(data) {
                    if(data["video_id"] != "None"){
                      $.ajax({
                        url: "https://eventretrieval.one/api/v1/submit?item="+data.video_id+"&frame="+data.frame_id+"&session=node0a0yuwswfadu2mjgfwcpzqzo744", 
                        type: "GET",
                        dataType: "json", 
                        success: function(result){
                          alert(result.description);
                        },
                        error: function(error){
                          var status=error.status;
                          if(status == 412){
                            alert("Duplicate or Wrong Format");
                          }else if(status == 401){
                            alert("Unauthorized Error");
                          }
                        }
                        });
                    }else{
                      alert("Video None")
                    }
                },
                error: function(xhr, ajaxOptions, thrownError) {
                    alert("Status: " + xhr.status + "     Error: " + thrownError);
                }
            });
        }
        

    </script>
</body>
</html> 
